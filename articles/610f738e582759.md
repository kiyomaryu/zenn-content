---
title: "GCPã§äºˆç®—è¨­å®šã‚’ã—ã¦cloud functionã‚’ä½¿ã£ã¦discordã«é€šçŸ¥ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ‘Œ"
type: "tech"
topics:
  - "gcp"
  - "discord"
  - "webhook"
  - "äºˆç®—"
published: true
published_at: "2022-01-31 18:40"
---

## ã¯ã˜ã‚ã«
zennã«ã¯åˆã‚ã¦ã®æŠ•ç¨¿ã«ãªã‚Šã¾ã™ã€‚  
ã“ã®åº¦GCPã«å…¥é–€ã—ã¦äºˆç®—è¨­å®šã‚’ã—é€šçŸ¥å…ˆã‚’discordã«è¨­å®šã—ãŸãŸã‚å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

## äºˆç®—è¨­å®š
äºˆç®—è¨­å®šã¯ä¸‹è¨˜ã®googleå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«è¨­å®šã—ã¾ã—ãŸã€‚
- [äºˆç®—è¨­å®šã¨ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š](https://cloud.google.com/billing/docs/how-to/budgets?hl=ja)

## cloud functionã‹ã‚‰discordã¸ã®é€šçŸ¥è¨­å®š
äºˆç®—è¨­å®šã¯ã—ã¾ã—ãŸãŒãƒ¡ãƒ¼ãƒ«ã ã‘ã§ã™ã¨è¦‹é€ƒã—ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œãªã„ã®ã§æ™®æ®µä½¿ã£ã¦ã„ã‚‹discordã‚µãƒ¼ãƒã«é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ä½œã£ã¦webhookã«ã¦é€šçŸ¥ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚  
å‚è€ƒã‚µã‚¤ãƒˆã®æƒ…å ±ã‚’å…ƒã«ä¸‹è¨˜ã®è¨­å®šã«ã—ã¾ã—ãŸã€‚  

### è¨­å®šå€¤
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ :node.js 16
- ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ:alertBudget

#### index.js
â€»discordã®webhookURLã¯ãƒã‚¹ã‚¯ã—ã¦ã¾ã™
```js
const { IncomingWebhook } = require('@slack/webhook');
/**
 * Background Cloud Function to be triggered by Pub/Sub.
 *
 * @param {object} event The Cloud Functions event.
 * @param {object} context
 */
exports.alertBudget = async pubsubEvent => {
  const pubsubData = Buffer.from(pubsubEvent.data, 'base64').toString();
  console.log(`${pubsubData}`);

  const obj = JSON.parse(pubsubData);
  if (obj.costAmount > obj.budgetAmount) {
    const body = {
      "text": "[Warning]GCPäºˆç®—ã‚’è¶…éã—ã¾ã—ãŸ\n" + 
      `*ç¾åœ¨ã®ä½¿ç”¨æ–™é‡‘*:${obj.costAmount} ${obj.currencyCode}`
    };
    // discordã«é€šçŸ¥
    const webhook = new IncomingWebhook('https://discord.com/api/webhooks/xxxxxxxxxxxx/xxxxxxxxxxxxxx/slack');
    await webhook.send(body);
  } else {
    console.log(`${obj.costAmount}/${obj.budgetAmount}`);
  }  
  return 'Discord notification sent successfully';
}
```

#### package.json
```json
{
  "name": "alert-budget-discord-http",
  "version": "0.0.1",
  "dependencies": {
    "@slack/webhook": "^6.1.0"
    }
}
```

### å‹•ä½œç¢ºèª

#### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿(å…ƒãƒ‡ãƒ¼ã‚¿)
```json
{
    "budgetDisplayName": "name-of-budget",
    "alertThresholdExceeded": 1.0,
    "costAmount": 100.01,
    "costIntervalStart": "2019-01-01T00:00:00Z",
    "budgetAmount": 100.00,
    "budgetAmountType": "SPECIFIED_AMOUNT",
    "currencyCode": "USD"
}
```

ã“ã‚Œã‚’Base64ã«ã—ã¦ä¸‹è¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨

ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿(base64)
```json
{"data": "ew0KICAgICJidWRnZXREaXNwbGF5TmFtZSI6ICJuYW1lLW9mLWJ1ZGdldCIsDQogICAgImFsZXJ0VGhyZXNob2xkRXhjZWVkZWQiOiAxLjAsDQogICAgImNvc3RBbW91bnQiOiAxMDAuMDEsDQogICAgImNvc3RJbnRlcnZhbFN0YXJ0IjogIjIwMTktMDEtMDFUMDA6MDA6MDBaIiwNCiAgICAiYnVkZ2V0QW1vdW50IjogMTAwLjAwLA0KICAgICJidWRnZXRBbW91bnRUeXBlIjogIlNQRUNJRklFRF9BTU9VTlQiLA0KICAgICJjdXJyZW5jeUNvZGUiOiAiVVNEIg0KfQ=="}
```

#### ãƒ†ã‚¹ãƒˆçµæœ
![ãƒ†ã‚¹ãƒˆçµæœ1](https://storage.googleapis.com/zenn-user-upload/714269c476e3-20220131.png)
![ãƒ†ã‚¹ãƒˆçµæœ2](https://storage.googleapis.com/zenn-user-upload/c8b21ff90df8-20220131.png)

é€šçŸ¥ã‚ªãƒƒã‚±ãƒ¼ã§ã™ï¼
æœ¬æ—¥ã¯ã“ã“ã¾ã§ã€‚

## å‚è€ƒã‚µã‚¤ãƒˆ
- [äºˆç®—è¨­å®šã¨ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š](https://cloud.google.com/billing/docs/how-to/budgets?hl=ja)

- [GCPäºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹](https://qiita.com/takezoux2/items/0cff8a2cc4f900cf1d29)
- [discordã§slackäº’æ›ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ](https://discord.com/developers/docs/resources/webhook#execute-slackcompatible-webhook)
- [slackã®webhookã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://slack.dev/node-slack-sdk/webhook)
- [äºˆç®—ã‚’slackbotã«é€šçŸ¥ã™ã‚‹æ–¹æ³•\(ã‚³ãƒ¼ãƒ‰ã‚„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‚è€ƒ\)](https://cloud.google.com/billing/docs/how-to/notify?hl=ja#functions_slack_dependencies-nodejs)